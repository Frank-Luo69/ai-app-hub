"use strict";(()=>{var e={};e.id=998,e.ids=[998],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},9490:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>R,requestAsyncStorage:()=>S,routeModule:()=>E,serverHooks:()=>j,staticGenerationAsyncStorage:()=>b});var s={};r.r(s),r.d(s,{POST:()=>v,runtime:()=>m});var a=r(9303),o=r(8716),i=r(670),n=r(7070),p=r(7410);let u=require("fs");var l=r(1017),c=r.n(l);let d=c().join(process.cwd(),"public","uploads");async function h(){await u.promises.mkdir(d,{recursive:!0})}class g{async put(e){var t;await h();let r=((t=e.contentType).includes("jpeg")||t.includes("jpg")?"jpg":t.includes("png")?"png":t.includes("webp")?"webp":"")||"bin",s=e.key||`${Date.now()}-${Math.random().toString(36).slice(2)}.${r}`,a=c().join(d,s);return await u.promises.writeFile(a,e.data),{url:`/uploads/${s}`,key:s,contentType:e.contentType,size:e.data.length}}async delete(e){try{let t=e.replace(/^\/?uploads\//,"").replace(/^https?:\/\/[^/]+\//,""),r=c().join(d,t);await u.promises.unlink(r)}catch{}}}var y=r(2814);class f{constructor(){if(this.url=process.env.NEXT_PUBLIC_SUPABASE_URL,this.serviceKey=process.env.SUPABASE_SERVICE_ROLE_KEY,this.bucket=process.env.SUPABASE_STORAGE_BUCKET_COVERS||"covers",!this.url||!this.serviceKey)throw Error("Supabase Storage requires URL and SERVICE_ROLE key")}client(){return(0,y.eI)(this.url,this.serviceKey)}async put(e){let t=e.key||`${Date.now()}-${Math.random().toString(36).slice(2)}`,{data:r,error:s}=await this.client().storage.from(this.bucket).upload(t,e.data,{contentType:e.contentType,upsert:!0});if(s)throw s;let{data:a}=this.client().storage.from(this.bucket).getPublicUrl(r.path);return{url:a.publicUrl,key:r.path,contentType:e.contentType,size:e.data.length}}async delete(e){let t=e.replace(/^https?:\/\/[^/]+\/storage\/v1\/object\/public\/[^/]+\//,"");await this.client().storage.from(this.bucket).remove([t])}}let m="nodejs",w=["image/jpeg","image/png","image/webp"],x=p.z.object({oldUrl:p.z.string().url().optional()});async function v(e){try{let t=await e.formData(),r=t.get("file"),s=t.get("oldUrl");if(!(r instanceof File))return n.NextResponse.json({error:"file required"},{status:400});let a=r.type,o=r.size;if(!w.includes(a))return n.NextResponse.json({error:"仅支持 jpg/png/webp"},{status:400});if(o>2097152)return n.NextResponse.json({error:"图片大小不能超过 2MB"},{status:400});s&&"string"==typeof s&&x.parse({oldUrl:s});let i=Buffer.from(await r.arrayBuffer()),p=function(){let e=!!process.env.NEXT_PUBLIC_SUPABASE_URL&&!!process.env.SUPABASE_SERVICE_ROLE_KEY;try{return e?new f:new g}catch{return new g}}();s&&"string"==typeof s&&await p.delete(s);let u=await p.put({data:i,contentType:a});return n.NextResponse.json({ok:!0,url:u.url,key:u.key})}catch(e){return n.NextResponse.json({error:e?.message||"upload failed"},{status:400})}}let E=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/workspaces/ai-app-hub/app/api/upload/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:S,staticGenerationAsyncStorage:b,serverHooks:j}=E,q="/api/upload/route";function R(){return(0,i.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:b})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,514],()=>r(9490));module.exports=s})();