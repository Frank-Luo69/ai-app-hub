(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[824],{1496:function(e,t,s){Promise.resolve().then(s.bind(s,1211))},1211:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return i}});var a=s(7437),r=s(2265),l=s(1180),n=s(4768);function i(e){let{params:t}=e,{t:s}=(0,n.Q)(),[i,c]=(0,r.useState)(null),[o,d]=(0,r.useState)([]),[u,m]=(0,r.useState)(null),[p,h]=(0,r.useState)(null),[f,x]=(0,r.useState)(!1),[g,v]=(0,r.useState)("");async function b(){if(!u)return alert("请先登录");if(!g.trim())return;let{error:e}=await l.O.from("comments").insert({app_id:i.id,content:g.trim()});e?alert(e.message):v("")}async function N(){var e;if(!i||!confirm("确认删除该应用？此操作不可恢复"))return;let{data:t}=await l.O.auth.getSession(),s=null===(e=t.session)||void 0===e?void 0:e.access_token,a=await fetch("/api/apps/".concat(i.id),{method:"DELETE",headers:s?{Authorization:"Bearer ".concat(s)}:void 0});if(!a.ok){alert((await a.json().catch(()=>({}))).error||"删除失败");return}window.location.href="/"}return((0,r.useEffect)(()=>{l.O.from("apps").select("*").eq("slug",t.slug).single().then(e=>c(e.data)),l.O.from("comments").select("*").order("created_at",{ascending:!1}).then(e=>d((e.data||[]).filter(e=>e.app_id))),l.O.auth.getUser().then(async e=>{var t,s;let a=e.data.user;if(m(null!==(t=null==a?void 0:a.email)&&void 0!==t?t:null),h(null!==(s=null==a?void 0:a.id)&&void 0!==s?s:null),null==a?void 0:a.id){let{data:e}=await l.O.rpc("is_admin",{uid:a.id});x(!!e)}})},[t.slug]),(0,r.useEffect)(()=>{if(!i)return;let e=l.O.channel("comments-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:"app_id=eq.".concat(i.id)},e=>d(t=>[e.new,...t])).subscribe();return()=>{l.O.removeChannel(e)}},[i]),i)?(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"md:col-span-2 space-y-4",children:[(0,a.jsxs)("div",{className:"card",children:[i.cover_url&&(0,a.jsx)("img",{src:i.cover_url,alt:i.title,className:"w-full h-64 object-cover rounded-xl border"}),(0,a.jsx)("h1",{className:"text-2xl font-semibold mt-4",children:i.title}),(0,a.jsx)("p",{className:"text-gray-600 mt-2 whitespace-pre-wrap",children:i.description}),(0,a.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:(i.tags||[]).map(e=>(0,a.jsx)("span",{className:"badge",children:e},e))}),(0,a.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["来源域名：",function(e){try{return new URL(e).host}catch(e){return""}}(i.play_url)]}),(0,a.jsx)("a",{href:i.play_url,target:"_blank",rel:"noopener noreferrer",className:"btn-primary px-4 py-2 rounded-xl",children:s("play")})]}),p&&(i.owner_id===p||f)&&(0,a.jsxs)("div",{className:"mt-3 flex gap-3",children:[(0,a.jsx)("a",{className:"btn",href:"/edit/".concat(i.id),children:"编辑"}),(0,a.jsx)("button",{className:"btn",onClick:N,children:s("delete")})]}),i.owner_email&&(0,a.jsxs)("div",{className:"text-sm text-gray-600 mt-2",children:["作者：",i.owner_email]})]}),(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("h2",{className:"font-semibold mb-3",children:"讨论区"}),(0,a.jsxs)("div",{className:"flex gap-2 mb-3",children:[(0,a.jsx)("input",{className:"flex-1 border rounded-xl px-3 py-2",placeholder:u?"写点什么…":"登录后才能发言",value:g,onChange:e=>v(e.target.value),disabled:!u}),(0,a.jsx)("button",{className:"btn",onClick:b,disabled:!u||!g.trim(),children:"发送"})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[o.filter(e=>e.app_id===i.id&&!e.is_deleted).map(e=>(0,a.jsxs)("div",{className:"border rounded-xl p-3",children:[(0,a.jsx)("div",{className:"text-sm text-gray-500",children:new Date(e.created_at).toLocaleString()}),(0,a.jsx)("div",{className:"mt-1 whitespace-pre-wrap",children:e.content})]},e.id)),0===o.filter(e=>e.app_id===i.id).length&&(0,a.jsx)("div",{className:"text-sm text-gray-500",children:"还没有评论，来占个沙发～"})]})]})]}),(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("h3",{className:"font-semibold",children:"安全提示"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"本平台仅收录外链，点击「去玩」将打开第三方站点。请注意甄别内容与版权。"})]})})]}):(0,a.jsx)("div",{children:"加载中…"})}},4768:function(e,t,s){"use strict";s.d(t,{I18nProvider:function(){return i},Q:function(){return c}});var a=s(7437),r=s(2265);let l={zh:{brand:"AI Mini-App Hub",submit:"提交应用",login:"登录",logout:"登出",searchPlaceholder:"搜索应用标题或简介…",noApps:"暂无应用，去「提交应用」发布一个吧～",play:"去玩",myApps:"我的应用",draft:"草稿",published:"已发布",filterAll:"全部",tags:"标签",prev:"上一页",next:"下一页",edit:"编辑",delete:"删除"},en:{brand:"AI Mini-App Hub",submit:"Submit App",login:"Login",logout:"Logout",searchPlaceholder:"Search by title or description…",noApps:"No apps yet — submit one!",play:"Play",myApps:"My Apps",draft:"Draft",published:"Published",filterAll:"All",tags:"Tags",prev:"Prev",next:"Next",edit:"Edit",delete:"Delete"}},n=(0,r.createContext)({t:e=>e,lang:"zh",setLang:()=>{}});function i(e){let{children:t}=e,[s,i]=(0,r.useState)("zh");(0,r.useEffect)(()=>{let e=localStorage.getItem("lang");("en"===e||"zh"===e)&&i(e)},[]),(0,r.useEffect)(()=>{localStorage.setItem("lang",s)},[s]);let c=(0,r.useMemo)(()=>e=>{var t;return null!==(t=l[s][e])&&void 0!==t?t:e},[s]),o=(0,r.useMemo)(()=>({t:c,lang:s,setLang:i}),[c,s]);return(0,a.jsx)(n.Provider,{value:o,children:t})}function c(){return(0,r.useContext)(n)}},1180:function(e,t,s){"use strict";s.d(t,{O:function(){return i}});var a=s(4593),r=s(357);let l=r.env.NEXT_PUBLIC_SUPABASE_URL,n=r.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,i=l&&n?(0,a.eI)(l,n):function(){let e=()=>{};return{from(e){let t={table:e,filter:{}},s={select:()=>s,eq:(e,a)=>(t.filter[e]=a,s),order:()=>Promise.resolve({data:[],error:null}),single:()=>"apps"===t.table&&"e2e-demo"===t.filter.slug?Promise.resolve({data:{id:"e2e-app-1",title:"E2E Demo App",slug:"e2e-demo",description:"Mock app for e2e without backend",cover_url:null,play_url:"https://example.com",source_host:"example.com",tags:["demo"],status:"active",owner_id:"owner-1",created_at:new Date().toISOString()},error:null}):Promise.resolve({data:null,error:{message:"not found (mock)"}}),insert:()=>Promise.resolve({data:null,error:{message:"unauthenticated (mock)"}}),update:()=>Promise.resolve({data:null,error:{message:"unauthenticated (mock)"}}),delete:()=>Promise.resolve({error:{message:"unauthenticated (mock)"}})};return s},rpc:async()=>({data:!1,error:null}),auth:{getUser:async()=>({data:{user:null},error:null}),getSession:async()=>({data:{session:null},error:null}),onAuthStateChange:(t,s)=>({subscription:{unsubscribe:e}}),signOut:async()=>({error:null})},channel:()=>({on:()=>({subscribe:()=>({})})}),removeChannel:e}}()}},function(e){e.O(0,[816,971,23,744],function(){return e(e.s=1496)}),_N_E=e.O()}]);